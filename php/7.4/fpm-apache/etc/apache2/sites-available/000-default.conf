<VirtualHost *:80>
    # Configure ServerAdmin and ServerName
    ServerName localhost
    ServerAdmin webmaster@localhost

    # Set CloudFlare Real IP
    RemoteIPHeader CF-Connecting-IP

    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    # Configure Log Settings
    LogFormat "%l %u %t %v %a \"%r\" %>s %b" comonvhost
    ErrorLog /dev/stderr
    TransferLog /dev/stdout
    LogLevel error

</VirtualHost>

<VirtualHost *:443>
    # Configure ServerAdmin and ServerName
    ServerName localhost
    ServerAdmin webmaster@localhost

    # Enable HTTP2
    Protocols h2 http/1.1

    # Configure main document root
    DocumentRoot ${APACHE_DOCUMENT_ROOT}

    # Set basic settings for document root. Configure correct directory indexes and disable directory browsing
    <Directory ${APACHE_DOCUMENT_ROOT}>
        AllowOverride All
        Order allow,deny
        Allow from all
        Options -Indexes +FollowSymLinks +MultiViews
        DirectoryIndex index.php index.html index.htm
    </Directory>

    # Prevent Apache from serving GIT folders
    <Directorymatch "^/.*/\.git/">
      Order deny,allow
      Deny from all
    </Directorymatch>

    # Prevent Apache from serving Jenkinsfile files
    <FilesMatch "\Jenkinsfile$">
      Order deny,allow
      Deny from all
    </FilesMatch>

    # Prevent Apache from serving Gitlab files
    <FilesMatch "\.gitlab-ci.yml$">
      Order deny,allow
      Deny from all
    </FilesMatch>

    # Disable XML-RPC on all wordpress sites
    <Files xmlrpc.php>
      Order deny,allow
      Deny from all
      # allow from xxx.xxx.xxx.xxx
    </Files>

    # For any files that match PHP, pass it to PHP-FPM for processing
    <FilesMatch "\.php$">
        # 2.4.10+ can proxy to unix socket
        ProxyFCGIBackendType GENERIC
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://localhost/"
    </FilesMatch>

    # Set the Proxy Timeout to be 30 minutes
    ProxyTimeout 1800

    # Configure Log Settings
    LogFormat "%l %u %t %v %a \"%r\" %>s %b" comonvhost
    ErrorLog /dev/stderr
    TransferLog /dev/stdout
    LogLevel error

    # Disable Server Signature for increased security
    ServerSignature Off

    # SSL Settings
    SSLEngine on
    SSLCertificateFile /etc/ssl/web/ssl.crt
    SSLCertificateKeyFile /etc/ssl/web/ssl.key

</VirtualHost>
